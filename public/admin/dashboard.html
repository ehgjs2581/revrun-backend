<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>REVRUN | ê´€ë¦¬ì</title>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      background: #0b0f14;
      color: #e8eef6;
    }
    .wrap {
      max-width: 1000px;
      margin: 24px auto;
      padding: 0 16px;
    }
    .top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 12px;
    }
    h1 {
      font-size: 24px;
      margin: 0;
    }
    .muted {
      opacity: 0.7;
      font-size: 14px;
    }
    button {
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      background: #4c7dff;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #5a8aff;
    }
    button.secondary {
      background: #1e293b;
      border: 1px solid #334155;
    }
    button.secondary:hover {
      background: #2d3a4f;
    }
    .card {
      background: #111826;
      border: 1px solid #223046;
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .card h2 {
      margin: 0 0 16px;
      font-size: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 600;
      opacity: 0.9;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #334155;
      background: #0f1419;
      color: #e8eef6;
      font-size: 14px;
      font-family: inherit;
      margin-bottom: 14px;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
      font-family: 'Courier New', monospace;
    }
    .field-group {
      margin-bottom: 18px;
    }
    .kpi-item {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .btn-remove {
      padding: 8px 12px;
      background: #dc2626;
      border-radius: 8px;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-remove:hover {
      background: #ef4444;
    }
    .btn-add {
      padding: 8px 14px;
      background: #059669;
      border-radius: 8px;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
      margin-top: 6px;
    }
    .btn-add:hover {
      background: #10b981;
    }
    .list-item {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .list-item input {
      flex: 1;
      margin-bottom: 0;
    }
    .success {
      background: #065f46;
      border: 1px solid #059669;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 16px;
    }
    .error {
      background: #7f1d1d;
      border: 1px solid #dc2626;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    
    <div class="top">
      <div>
        <h1>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
        <div class="muted" id="userInfo">ë¡œë”© ì¤‘...</div>
      </div>
      <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div id="message"></div>

    <div class="card">
      <h2>ë¦¬í¬íŠ¸ ì‘ì„±</h2>

      <div class="field-group">
        <label>ê³ ê° ì„ íƒ</label>
        <select id="clientSelect">
          <option value="">-- ê³ ê°ì„ ì„ íƒí•˜ì„¸ìš” --</option>
        </select>
      </div>

      <div class="field-group">
        <label>ê¸°ê°„</label>
        <select id="periodSelect">
          <option value="ìµœê·¼ 7ì¼">ìµœê·¼ 7ì¼</option>
          <option value="ìµœê·¼ 14ì¼">ìµœê·¼ 14ì¼</option>
          <option value="ìµœê·¼ 30ì¼">ìµœê·¼ 30ì¼</option>
        </select>
      </div>

      <div class="field-group">
        <label>KPI í•­ëª©</label>
        <div id="kpiContainer"></div>
        <button class="btn-add" onclick="addKpi()">+ KPI ì¶”ê°€</button>
      </div>

      <div class="field-group">
        <label>í•˜ì´ë¼ì´íŠ¸ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
        <textarea id="highlightsInput" placeholder="ì˜ˆ:&#10;ê´‘ê³  ì˜ˆì‚° ëŒ€ë¹„ ë¬¸ì˜ ì¦ê°€ ì¶”ì„¸&#10;ì „í™˜ìœ¨ 20% í–¥ìƒ"></textarea>
      </div>

      <div class="field-group">
        <label>ë‹¤ìŒ ì•¡ì…˜ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
        <textarea id="actionsInput" placeholder="ì˜ˆ:&#10;í‚¤ì›Œë“œ ì¶”ê°€ í…ŒìŠ¤íŠ¸ ì§„í–‰&#10;ê´‘ê³  ì†Œì¬ A/B í…ŒìŠ¤íŠ¸"></textarea>
      </div>

      <button onclick="saveReport()" style="width:100%; padding:14px; font-size:15px;">ğŸ’¾ ë¦¬í¬íŠ¸ ì €ì¥</button>
    </div>

    <div class="card">
      <h2>ìµœê·¼ ë¦¬í¬íŠ¸ ëª©ë¡</h2>
      <div id="reportsList">
        <div class="muted">ê³ ê°ì„ ì„ íƒí•˜ë©´ ë¦¬í¬íŠ¸ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </div>

  </div>

  <script>
    let clients = [];

    async function api(path, opts = {}) {
      const res = await fetch(path, {
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        ...opts
      });
      return res.json();
    }

    function showMessage(text, type = "success") {
      const el = document.getElementById("message");
      el.className = type;
      el.textContent = text;
      setTimeout(() => { el.innerHTML = ""; el.className = ""; }, 5000);
    }

    async function logout() {
      await api("/api/logout", { method: "POST" });
      location.href = "/report/login.html";
    }

    function addKpi() {
      const container = document.getElementById("kpiContainer");
      const div = document.createElement("div");
      div.className = "kpi-item";
      div.innerHTML = `
        <input type="text" placeholder="í•­ëª©ëª… (ì˜ˆ: ê´‘ê³ ë¹„)" class="kpi-label" />
        <input type="text" placeholder="ê°’ (ì˜ˆ: 1,200,000ì›)" class="kpi-value" />
        <button class="btn-remove" onclick="this.parentElement.remove()">ì‚­ì œ</button>
      `;
      container.appendChild(div);
    }

    function getKpis() {
      const items = document.querySelectorAll(".kpi-item");
      const kpis = [];
      items.forEach(item => {
        const label = item.querySelector(".kpi-label").value.trim();
        const value = item.querySelector(".kpi-value").value.trim();
        if (label && value) {
          kpis.push({ label, value });
        }
      });
      return kpis;
    }

    function textToArray(text) {
      return text.split("\n").map(s => s.trim()).filter(Boolean);
    }

    async function saveReport() {
      const clientId = document.getElementById("clientSelect").value;
      if (!clientId) {
        showMessage("âŒ ê³ ê°ì„ ì„ íƒí•´ì£¼ì„¸ìš”", "error");
        return;
      }

      const period = document.getElementById("periodSelect").value;
      const kpis = getKpis();
      const highlights = textToArray(document.getElementById("highlightsInput").value);
      const actions = textToArray(document.getElementById("actionsInput").value);

      if (kpis.length === 0) {
        showMessage("âŒ ìµœì†Œ 1ê°œ ì´ìƒì˜ KPIë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”", "error");
        return;
      }

      const payload = { kpis, highlights, actions };

      const data = await api("/api/admin/report", {
        method: "POST",
        body: JSON.stringify({
          user_id: clientId,
          period,
          payload
        })
      });

      if (data.ok) {
        showMessage("âœ… ë¦¬í¬íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        loadReports(clientId);
        // í¼ ì´ˆê¸°í™”
        document.getElementById("kpiContainer").innerHTML = "";
        document.getElementById("highlightsInput").value = "";
        document.getElementById("actionsInput").value = "";
        addKpi(); // ê¸°ë³¸ 1ê°œ
      } else {
        showMessage("âŒ ì €ì¥ ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"), "error");
      }
    }

    async function loadReports(userId) {
      const data = await api(`/api/admin/reports?user_id=${userId}`);
      const list = document.getElementById("reportsList");
      
      if (!data.ok || !data.reports || data.reports.length === 0) {
        list.innerHTML = '<div class="muted">ì €ì¥ëœ ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      list.innerHTML = data.reports.map(r => `
        <div style="padding:10px; background:#0b1220; border:1px solid #223046; border-radius:8px; margin-bottom:8px;">
          <div><strong>${r.period || "ê¸°ê°„ ë¯¸ì§€ì •"}</strong></div>
          <div class="muted" style="font-size:12px;">${new Date(r.created_at).toLocaleString('ko-KR')}</div>
        </div>
      `).join("");
    }

    async function boot() {
      // ë¡œê·¸ì¸ ì²´í¬
      const me = await api("/api/me");
      if (!me?.user || me.user.role !== "admin") {
        location.href = "/report/login.html";
        return;
      }
      document.getElementById("userInfo").textContent = `${me.user.name || me.user.username} (ê´€ë¦¬ì)`;

      // ê³ ê° ëª©ë¡ ë¡œë“œ
      const data = await api("/api/admin/clients");
      if (data.ok && data.clients) {
        clients = data.clients;
        const select = document.getElementById("clientSelect");
        clients.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = `${c.name || c.username} (${c.username})`;
          select.appendChild(opt);
        });
      }

      // ê³ ê° ì„ íƒ ì‹œ ë¦¬í¬íŠ¸ ëª©ë¡ ë¡œë“œ
      document.getElementById("clientSelect").addEventListener("change", (e) => {
        const userId = e.target.value;
        if (userId) {
          loadReports(userId);
        } else {
          document.getElementById("reportsList").innerHTML = '<div class="muted">ê³ ê°ì„ ì„ íƒí•˜ë©´ ë¦¬í¬íŠ¸ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>';
        }
      });

      // ê¸°ë³¸ KPI 1ê°œ ì¶”ê°€
      addKpi();
    }

    boot();
  </script>
</body>
</html>